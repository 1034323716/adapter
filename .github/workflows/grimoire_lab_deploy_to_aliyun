name: CHAOSS Toolset GrimoireLab Deploy to Aliyun
run-name: ${{ github.actor }} manually deploy GrimoireLab to aliyun
 
on:
  workflow_dispatch:

env:
  CGO_ENABLED: 0
  GOOS: linux
  WORK_DIR: module-controller
  
  
defaults:
  run:
    working-directory: module-controller

jobs:
  build:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Docker login
      uses: docker/login-action@v2.2.0
      with:
       registry: ${{ env.DOCKERHUB_REGISTRY }}
       username: ${{ secrets.DOCKERHUB_USERNAME }}
       password: ${{ secrets.DOCKERHUB_PASSWORD }}
       logout: false

    - name: Set up Docker buildx
      uses: docker/setup-buildx-action@v2

    - name: Cache Docker layers
      uses: actions/cache@v2
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ hashFiles('${{ env.WORK_DIR }}/*Dockerfile') }}

    - name: Build and push module-controller Docker images
      uses: docker/build-push-action@v4.1.1
      with:
        context: ${{ env.WORK_DIR }}
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache
        file: ${{ env.WORK_DIR }}/Dockerfile
        platforms: linux/amd64
        push: true
        tags: ${{ env.DOCKERHUB_REGISTRY }}/${{ env.MODULE_CONTROLLER_IMAGE_PATH }}:${{ env.TAG }}

    - run: sleep 30

    - name: Build and push module-controller-integration-tests Docker images
      uses: docker/build-push-action@v4.1.1
      with:
        context: ${{ env.WORK_DIR }}
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache
        file: ${{ env.WORK_DIR }}/IntegrationTestsDockerfile
        platforms: linux/amd64
        push: true
        tags: ${{ env.DOCKERHUB_REGISTRY }}/${{ env.INTEGRATION_TESTS_IMAGE_PATH }}:${{ env.TAG }}
